# API测试脚本使用说明

## 快速开始

### 1. 启动API服务
```bash
python app.py
```

### 2. 运行完整测试
```bash
python test_api.py
```

## 测试脚本功能

### 🎯 测试项目
- **健康检查**: 验证API服务是否正常运行
- **普通聊天**: 测试基本的图像+文本对话功能
- **流式聊天**: 测试实时流式输出功能
- **多图片对话**: 测试多张图片的对话能力
- **错误处理**: 测试各种异常情况的处理
- **性能测试**: 测试API响应时间和稳定性

### 📊 测试输出
- ✅ 成功信息（绿色）
- ❌ 错误信息（红色）
- ℹ️ 普通信息（蓝色）
- 📊 统计信息

## 命令行参数

### 基本用法
```bash
# 运行所有测试（默认）
python test_api.py

# 指定服务器地址
python test_api.py --url http://your-server:8000

# 运行特定测试
python test_api.py --test health
python test_api.py --test chat
python test_api.py --test stream
python test_api.py --test multi
python test_api.py --test error
python test_api.py --test performance
```

### 参数说明
- `--url`: API服务器地址（默认: http://localhost:8000）
- `--test`: 测试类型
  - `health`: 健康检查
  - `chat`: 普通聊天
  - `stream`: 流式聊天
  - `multi`: 多图片对话
  - `error`: 错误处理
  - `performance`: 性能测试
  - `all`: 所有测试（默认）

## 示例输出

```
🚀 开始方舟AI图像识别API测试
📡 目标服务器: http://localhost:8000

==================================================
 健康检查测试
==================================================
✅ 健康检查成功: {'message': '方舟AI图像识别API服务正在运行'}

==================================================
 普通聊天测试
==================================================
✅ 普通聊天成功 (耗时: 2.34秒)
ℹ️  回复内容: 这是一张城市景观图片...

==================================================
 流式聊天测试
==================================================
✅ 流式聊天连接成功 (耗时: 0.12秒)
ℹ️  开始接收流式数据:
这是一张城市景观图片，画面中可以看到...
✅ 流式聊天完成，共接收 15 个数据块
ℹ️  完整回复长度: 256 字符

==================================================
 测试总结
==================================================
健康检查: ✅ 通过
普通聊天: ✅ 通过
流式聊天: ✅ 通过
多图片对话: ✅ 通过
错误处理: ✅ 通过
性能测试: ✅ 通过

📊 总体结果: 6/6 项测试通过
🎉 所有测试通过！API服务运行正常
```

## 故障排除

### 常见问题

1. **连接失败**
   ```
   ❌ 无法连接到API服务，请确保服务已启动
   ```
   - 确保API服务已启动：`python app.py`
   - 检查端口是否正确（默认8000）
   - 检查防火墙设置

2. **API密钥错误**
   ```
   ❌ API调用失败: Invalid API key
   ```
   - 检查`app.py`中的API密钥是否正确
   - 确保API密钥有足够的配额

3. **图片URL无效**
   ```
   ❌ 普通聊天失败: HTTP 500
   ```
   - 确保图片URL可以公开访问
   - 检查图片格式是否支持

### 调试模式
如果需要更详细的错误信息，可以修改测试脚本中的异常处理部分。

## 自定义测试

您可以根据需要修改测试脚本：

1. **修改测试图片**: 更改`test_data`中的`image_url`
2. **修改测试问题**: 更改`text`字段的内容
3. **添加新测试**: 在`ArkAPITester`类中添加新的测试方法
4. **修改性能测试次数**: 更改`test_performance`中的循环次数

## 集成到CI/CD

测试脚本返回适当的退出码，可以集成到持续集成流程中：

```bash
python test_api.py
if [ $? -eq 0 ]; then
    echo "测试通过"
else
    echo "测试失败"
    exit 1
fi
``` 